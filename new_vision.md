

### Инструкция по работе системы "HerZog": от Загрузки до Готового Графика

#### **Общая Архитектура Проекта**

```
/Herzog_v2claude/
│
├── .env                          # Секреты: API-ключи, токен бота
│
├── main_bot.py                   # ТОЧКА ВХОДА: Запуск телеграм-бота
│
├── /projects/                    # Корневая папка для всех проектов
│   └── /{user_id}/               # Папка конкретного пользователя
│       └── /{project_id}/        # Папка конкретного проекта
│           │
│           ├── 0_input/          # Шаг 0: Все, что прислал пользователь
│           │   ├── context.json
│           │   └── estimates.xlsx
│           │
│           ├── 1_extracted/      # Шаг 1: Сырые данные после парсинга
│           │   └── raw_estimates.json
│           │
│           ├── 2_classified/     # Шаг 2: Данные с проставленной классификацией
│           │   ├── llm_request.json
│           │   ├── llm_response.json
│           │   └── classified_estimates.json
│           │
│           ├── 3_prepared/       # Шаг 3: Единый, чистый файл проекта для агентов
│           │   └── project_data.json
│           │
│           ├── ... (папки 4, 5, 6, 7 для каждого агента) ...
│           │
│           └── 8_output/         # Финальный результат
│               └── schedule.xlsx
│
└── /src/                         # Исходный код
    │
    ├── main_pipeline.py          # "Дирижер" всего конвейера
    │
    ├── telegram_bot/             # Логика телеграм-бота (прием файлов и команд)
    │
    ├── data_processing/          # Модули для работы с данными
    │   ├── extractor.py          # 1. Парсер Excel
    │   ├── classifier.py         # 2. Классификатор "Работа/Материал"
    │   ├── preparer.py           # 3. Сборщик единого файла проекта
    │   └── reporter.py           # 8. Генератор Excel-отчета
    │
    ├── ai_agents/                # "Мозги" системы
    │   ├── agent_1_conceptualizer.py
    │   ├── agent_2_strategist.py
    │   ├── agent_3_accountant.py
    │   └── agent_4_foreman.py
    │
    └── ... (core, shared, prompts)
```

---

### Пошаговый Производственный Процесс
Финальная Архитектура (Версия 3.0: "Политический Инструмент")
Ключевая Философия: Мы создаем не симулятор стройки, а инструмент для быстрого формирования управляемого графика. Система должна быть гибкой, чтобы отражать не только техническую логику, но и бизнес-требования заказчика. Промты — коммерческая тайна.

Пошаговый Пайплайн и Структура Папок
Шаг 0: Сбор Директив (Модуль: telegram_bot)
Действие бота (Пошаговый опрос):
"Пришлите файлы сметы, можете добавить еще файлы или нажать “далее” (.xlsx)."
"Укажите желаемое количество строк в итоговом графике (например, 15)." -> target_work_count.
"Укажите диапазон дат проекта (от ДД.ММ.ГГГГ до ДД.ММ.ГГГГ)." -> project_timeline.
"Укажите желаемое количество рабочих на площадке (можно диапазоном, например, 10-20)." -> workforce_range.
"Есть ли особые указания по ГРУППИРОВКЕ работ? (Например: 'всю электрику в один блок, а полы не трогай'). Если нет, просто пропустите." -> directives.conceptualizer.
"Есть ли особые указания по ПЛАНИРОВАНИЮ этапов? (Например: 'растяни демонтаж на весь первый месяц'). Если нет, пропустите." -> directives.strategist.
"Есть ли особые указания по ПОДСЧЕТУ объемов? (Например: 'при объединении полов считай только площадь'). Если нет, пропустите." -> directives.accountant.
"Есть ли особые указания по РАСПРЕДЕЛЕНИЮ людей? (Например: 'на отделку кинь максимум людей'). Если нет, пропустите." -> directives.foreman.
Результат: В папке .../{project_id}/0_input/ создаются два файла: estimate.xlsx и directives.json.

#### **Шаг 1: Извлечение Данных (Модуль: `data_processing/extractor.py`)**

1.  **Вход:** Путь к `.../0_input/estimates.xlsx`.
2.  **Действие:** Скрипт-парсер `extractor.py` читает Excel-файл и извлекает из него **все строки как есть** (работы, материалы, заголовки, пустые строки).
3.  **Результат:** В папке `1_extracted/` создается файл `raw_estimates.json`, содержащий сырой, нефильтрованный список всех позиций из сметы.

#### **Шаг 2: Классификация "Работа/Материал" (Модуль: `data_processing/classifier.py`)**

1.  **Вход:** Путь к `.../1_extracted/raw_estimates.json`.
2.  **Действие:**
    *   Скрипт `classifier.py` пробегает по всем позициям в `raw_estimates.json`.
    *   **Первый проход (по правилам):** Он пытается присвоить каждой позиции тег `classification` ("Работа", "Материал"), используя жесткие правила (например, по префиксу кода "ГЭСН", "ФССЦ").
    *   **Второй проход (AI для сложных случаев):** Все позиции, которые не удалось классифицировать (получили тег "Иное" или "Неопределенное"), собираются в список и отправляются в LLM с простым промтом: /home/imort/Herzog_v2claude/promts/gemini_classification_prompt.txt.
    *   Ответ от LLM используется для обновления тегов `classification` у этих сложных позиций.
3.  **Результат:** В папке `2_classified/` создается файл `classified_estimates.json`. Это тот же список позиций, но теперь у каждой из них есть четкий тег `classification` ("Работа" или "Материал"). Также здесь сохраняются логи запросов/ответов LLM для отладки.

#### **Шаг 3: Подготовка Рабочего Пространства (Модуль: `data_processing/preparer.py`)**

1.  **Вход:**
    *   Путь к `.../2_classified/classified_estimates.json`.
    *   Путь к `.../0_input/directives.json`.
    *   Вызов модуля `shared/timeline_blocks.py` для получения временных блоков.
2.  **Действие:**
    *   Скрипт `preparer.py` выполняет ключевую работу по "сборке" проекта.
    *   Он читает `classified_estimates.json` и **отфильтровывает** из него только позиции с `classification: "Работа"`.
    *   Он читает `directives.json`.
    *   Он получает `timeline_blocks`.
    *   Он собирает все эти данные в **один, единый, чистый JSON-файл**.
3.  **Результат:** В папке `3_prepared/` создается главный файл проекта `project_data.json`. Этот файл является "единым источником правды" для всех последующих AI-агентов.


Шаги 4-7: Работа Конвейера AI-Агентов (с сохранением логов)

Общий принцип работы каждого AI-агента (agent_X.py):
Чтение: Загружает project_data.json из папки предыдущего этапа.
Формирование Запроса:
Скрипт готовит данные для LLM (список работ, группы и т.д.).
Скрипт загружает свой секретный промт из папки /src/prompts/.
Скрипт встраивает директиву пользователя из project_data.json в конец промта.
Весь готовый запрос к LLM сохраняется в файл .../{step_N}/llm_input.json.
Вызов LLM: Отправляет запрос.
Обработка и Сохранение Ответа:
Получает ответ от LLM.
Сырой ответ от LLM сохраняется в файл .../{step_N}/llm_response.json. Это бесценно для отладки.
Скрипт парсит ответ, обогащает основной project_data.json новыми данными.
Обновленный project_data.json сохраняется в папку текущего шага .../{step_N}/.
Пример структуры папки для Агента 1 "Концептуализатор":
/projects/{...}/4_conceptualized/
│
├── llm_input.json              # Полный текст, отправленный в Gemini (наш секретный промт + данные + директива).
│
├── llm_response.json           # Сырой JSON, который вернул Gemini.
│
└── project_data.json           # Главный файл проекта, обогащенный результатами этого шага (добавлены group_id).


Шаг 8: Финальный Отчет (Модуль reporter.py)
Этот шаг остается без изменений. Это чистый Python-скрипт, который берет финальный project_data.json из папки 7 и генерирует Excel-файл в папку 8_output/.
Архитектура проекта (финальная версия)
Структура папок проектов:
/projects/{user_id}/{project_id}/
├── 0_input/
│   ├── estimate.xlsx
│   └── directives.json  # Содержит все управляющие параметры и указания
│
├── 1_extracted/
│   └── raw_estimates.json
│
├── 2_classified/
│   └── classified_estimates.json
│
├── 3_prepared/
│   └── project_data.json  # Единый файл проекта для старта конвейера
│
├── 4_conceptualized/ (Агент 1)
│   ├── llm_input.json, llm_response.json, project_data.json
│
├── 5_scheduled/ (Агент 2)
│   ├── llm_input.json, llm_response.json, project_data.json
│
├── 6_accounted/ (Агент 3)
│   ├── llm_input.json, llm_response.json, project_data.json
│
├── 7_staffed/ (Агент 4)
│   ├── llm_input.json, llm_response.json, project_data.json
│
└── 8_output/
    └── schedule.xlsx

Суть разработки, промты все в папке promts, работаем инкрементально, для начала строим архитектуру, промты делаем потом!




